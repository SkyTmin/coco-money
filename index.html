<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>CocoMoney</title>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    .list { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; }
    .expenses { margin-left: 1rem; }
    button { margin-left: 0.5rem; }
  </style>
</head>
<body>
  <h1>üí∏ CocoMoney</h1>

  <form id="new-list-form">
    <input type="text" id="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required>
    <input type="number" id="budget" placeholder="–ë—é–¥–∂–µ—Ç" required>
    <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
  </form>

  <div id="lists"></div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    const supabase = createClient(
      "https://vflflxppglrgdcxeszzu.supabase.co", // ‚Üê –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZmbGZseHBwZ2xyZ2RjeGVzenp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU1MjI4MzMsImV4cCI6MjA2MTA5ODgzM30.oFsEJ21xU05QyXZxfSXv0WKW4P8ps3HcB4Ot7kK7DDQ"                    // ‚Üê –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à
    );

    const listsContainer = document.getElementById('lists');
    const form = document.getElementById('new-list-form');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value;
      const budget = parseFloat(document.getElementById('budget').value);

      const { error } = await supabase.from('cocomoney').insert({
        name,
        budget,
        remaining: budget,
        expenses: []
      });

      if (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞:', error);
      } else {
        form.reset();
        fetchLists();
      }
    });

    async function fetchLists() {
      const { data, error } = await supabase.from('cocomoney').select('*');
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–æ–≤:', error);
        return;
      }

      listsContainer.innerHTML = '';
      data.forEach(list => {
        const div = document.createElement('div');
        div.className = 'list';
        div.innerHTML = `
          <strong>${list.name}</strong> (–û—Å—Ç–∞–ª–æ—Å—å: ${list.remaining} –∏–∑ ${list.budget})
          <button onclick="deleteList(${list.id})">–£–¥–∞–ª–∏—Ç—å</button>
          <form onsubmit="addExpense(event, ${list.id})">
            <input type="text" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–∞—Ç—ã" required>
            <input type="number" name="amount" placeholder="–°—É–º–º–∞" required>
            <button type="submit">‚ûï</button>
          </form>
          <div class="expenses">
            ${list.expenses.map(exp => `
              <div>
                ${exp.title} - ${exp.amount}
                <button onclick="deleteExpense(${list.id}, '${exp.id}')">‚úñÔ∏è</button>
              </div>
            `).join('')}
          </div>
        `;
        listsContainer.appendChild(div);
      });
    }

    window.addExpense = async (e, listId) => {
      e.preventDefault();
      const form = e.target;
      const title = form.title.value;
      const amount = parseFloat(form.amount.value);

      const { data, error } = await supabase.from('cocomoney').select('*').eq('id', listId).single();
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏:', error);
        return;
      }

      const expense = { id: crypto.randomUUID(), title, amount };
      const updatedExpenses = [...data.expenses, expense];
      const updatedRemaining = data.remaining - amount;

      const { error: updateError } = await supabase.from('cocomoney').update({
        expenses: updatedExpenses,
        remaining: updatedRemaining
      }).eq('id', listId);

      if (updateError) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', updateError);
        return;
      }

      fetchLists();
    };

    window.deleteList = async (id) => {
      const { error } = await supabase.from('cocomoney').delete().eq('id', id);
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞:', error);
        return;
      }
      fetchLists();
    };

    window.deleteExpense = async (listId, expenseId) => {
      const { data, error } = await supabase.from('cocomoney').select('*').eq('id', listId).single();
      if (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏:', error);
        return;
      }

      const updatedExpenses = data.expenses.filter(e => e.id !== expenseId);
      const deleted = data.expenses.find(e => e.id === expenseId);
      const updatedRemaining = data.remaining + (deleted?.amount || 0);

      const { error: updateError } = await supabase.from('cocomoney').update({
        expenses: updatedExpenses,
        remaining: updatedRemaining
      }).eq('id', listId);

      if (updateError) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏:', updateError);
        return;
      }

      fetchLists();
    };

    fetchLists();
  </script>
</body>
</html>
